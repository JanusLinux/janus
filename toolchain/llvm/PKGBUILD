pkgname=llvm
pkgver=6.0.0
pkgrel=1
arch=('any')
source=("http://llvm.org/releases/$pkgver/llvm-$pkgver.src.tar.xz"
	"http://llvm.org/releases/$pkgver/cfe-$pkgver.src.tar.xz"
	"http://llvm.org/releases/$pkgver/compiler-rt-$pkgver.src.tar.xz"
	"http://llvm.org/releases/$pkgver/libunwind-$pkgver.src.tar.xz"
	"llvm-003-musl.patch"
	"cfe-001-fix-stdint.patch"
	"cfe-003-fix-unwind-chain-inclusion.patch"
	"cfe-004-add-musl-triples.patch")

prepare() {
	cd $srcdir/$pkgname-$pkgver.src
	mkdir build
	msg "Patching LLVM"
	patch -Np1 -i $srcdir/llvm-003-musl.patch

	cd $srcdir/cfe-$pkgver.src
	msg "Patching Clang"
	patch -Np1 -i $srcdir/cfe-001-fix-stdint.patch
	patch -Np1 -i $srcdir/cfe-003-fix-unwind-chain-inclusion.patch
	patch -Np1 -i $srcdir/cfe-004-add-musl-triples.patch

	cd $srcdir/compiler-rt-$pkgver.src
	msg "Patching compiler-rt"
	sed -i 's/set(COMPILER_RT_HAS_SANITIZER_COMMON TRUE)/set(COMPILER_RT_HAS_SANITIZER_COMMON FALSE)/' cmake/config-ix.cmake

	cd $srcdir/$pkgname-$pkgver.src
	mv $srcdir/cfe-$pkgver.src tools/clang
	mv $srcdir/compiler-rt-$pkgver.src projects/compiler-rt
	mv $srcdir/libunwind-$pkgver.src projects/libunwind
}

build() {
	cd $srcdir/$pkgname-$pkgver.src
	cd build
	cmake $srcdir/$pkgname-$pkgver.src \
		-DCMAKE_C_COMPILER=$HOSTCC \
		-DCMAKE_CXX_COMPILER=$HOSTCXX \
		-DLIBUNWIND_ENABLE_SHARED=ON \
		-DCLANG_DEFAULT_LINKER=$XTARGET-ld \
		-DCLANG_DEFAULT_RTLIB=compiler-rt \
		-DLLVM_DEFAULT_TARGET_TRIPLE=$XTARGET \
		-DDEFAULT_SYSROOT=$ROOTFS \
		-DCMAKE_INSTALL_PREFIX= \
		-DCMAKE_BUILD_TYPE=Release \
		-DLLVM_TARGET_ARCH="$LARCH" \
		-DLLVM_TARGETS_TO_BUILD="$TARGETS" \
		-DLLVM_BUILD_LLVM_DYLIB=ON \
		-DLLVM_LINK_LLVM_DYLIB=OFF
	make
}

package() {
	unset MAKEFLAGS
	cd $srcdir/$pkgname-$pkgver.src
	cd build
	make DESTDIR=$pkgdir install
}
