From 76442995fc672b0508be4aa00428b8df3042da8d Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Wed, 19 Aug 2020 21:38:01 +0500
Subject: [PATCH 1/2] allow building without systemd journald

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 configure.ac            |  1 -
 doc/Makefile.am         |  3 +--
 src/lib/Makefile.am     |  1 -
 src/lib/logging.c       |  6 ++++--
 src/plugins/Makefile.am | 21 +--------------------
 5 files changed, 6 insertions(+), 26 deletions(-)

diff --git a/configure.ac b/configure.ac
index f417fb0..65ab7ac 100644
--- a/configure.ac
+++ b/configure.ac
@@ -228,7 +228,6 @@ PKG_CHECK_MODULES([PROXY], [libproxy-1.0], [
     AC_DEFINE([HAVE_PROXY], [1], [Use libproxy])
 ], [:])
 PKG_CHECK_MODULES([SATYR], [satyr])
-PKG_CHECK_MODULES([JOURNAL], [libsystemd])
 PKG_CHECK_MODULES([AUGEAS], [augeas])
 PKG_CHECK_MODULES([LIBARCHIVE], [libarchive])
 
diff --git a/doc/Makefile.am b/doc/Makefile.am
index 068b826..29e7702 100644
--- a/doc/Makefile.am
+++ b/doc/Makefile.am
@@ -33,8 +33,7 @@ MAN1_TXT = \
 	reporter-print.txt \
 	reporter-upload.txt \
 	reporter-ureport.txt \
-	reporter-mantisbt.txt \
-	reporter-systemd-journal.txt
+	reporter-mantisbt.txt
 
 MAN5_TXT = \
 	anaconda_event.conf.txt \
diff --git a/src/lib/Makefile.am b/src/lib/Makefile.am
index b8da311..881403b 100644
--- a/src/lib/Makefile.am
+++ b/src/lib/Makefile.am
@@ -103,7 +103,6 @@ libreport_la_LIBADD = \
     $(GIO_LIBS) \
     $(GLIB_LIBS) \
     $(LIBARCHIVE_LIBS) \
-    $(JOURNAL_LIBS) \
     $(GOBJECT_LIBS) \
     $(AUGEAS_LIBS) \
     $(NETTLE_LIBS) \
diff --git a/src/lib/logging.c b/src/lib/logging.c
index 7c09777..7f07cd9 100644
--- a/src/lib/logging.c
+++ b/src/lib/logging.c
@@ -18,8 +18,8 @@
 */
 #include <syslog.h>
 /* Suppress automatic CODE_* fields as we handle those here */
-#define SD_JOURNAL_SUPPRESS_LOCATION
-#include <systemd/sd-journal.h>
+//#define SD_JOURNAL_SUPPRESS_LOCATION
+//#include <systemd/sd-journal.h>
 #include "internal_libreport.h"
 
 void (*libreport_g_custom_logger)(const char*);
@@ -146,6 +146,7 @@ static void log_handler(int level,
         libreport_g_custom_logger(msg + prefix_len);
     }
 
+#if 0
     if (flags & LOGMODE_JOURNAL) {
         sd_journal_send("MESSAGE=%s", msg + prefix_len,
                         "PRIORITY=%d", level,
@@ -155,6 +156,7 @@ static void log_handler(int level,
                         "SYSLOG_FACILITY=1",
                         NULL);
     }
+#endif
 }
 
 void log_wrapper(int level,
diff --git a/src/plugins/Makefile.am b/src/plugins/Makefile.am
index 5198905..f991695 100644
--- a/src/plugins/Makefile.am
+++ b/src/plugins/Makefile.am
@@ -19,8 +19,7 @@ bin_PROGRAMS = $(reporters_bin) \
     reporter-kerneloops \
     reporter-upload \
     reporter-mailx \
-    reporter-print \
-    reporter-systemd-journal
+    reporter-print
 
 pluginsconfdir = $(PLUGINS_CONF_DIR)
 
@@ -245,24 +244,6 @@ reporter_print_CPPFLAGS = \
 reporter_print_LDADD = \
     ../lib/libreport.la
 
-reporter_systemd_journal_SOURCES = \
-    reporter-systemd-journal.c
-reporter_systemd_journal_CPPFLAGS = \
-    -I$(srcdir)/../include \
-    -I$(srcdir)/../lib \
-    -DBIN_DIR=\"$(bindir)\" \
-    -DLOCALSTATEDIR='"$(localstatedir)"' \
-    -DDEBUG_DUMPS_DIR=\"$(DEBUG_DUMPS_DIR)\" \
-    -DDEBUG_INFO_DIR=\"$(DEBUG_INFO_DIR)\" \
-    -DPLUGINS_LIB_DIR=\"$(PLUGINS_LIB_DIR)\" \
-    -DPLUGINS_CONF_DIR=\"$(REPORT_PLUGINS_CONF_DIR)\" \
-    $(GLIB_CFLAGS) \
-    $(LIBREPORT_CFLAGS) \
-    -D_GNU_SOURCE
-reporter_systemd_journal_LDADD = \
-    ../lib/libreport.la \
-    $(JOURNAL_LIBS)
-
 if BUILD_UREPORT
 reporter_ureport_SOURCES = \
     reporter-ureport.c
-- 
2.18.4

