From 7b29dbd4f4f280dced03799c4948097a60078c66 Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Wed, 23 Sep 2020 23:16:35 +0900
Subject: [PATCH] add support for Ataraxia Linux PAM

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 data/meson.build                             |  8 ++++++++
 data/pam-ataraxia/gdm-autologin.pam          | 13 +++++++++++++
 data/pam-ataraxia/gdm-fingerprint.pam        | 13 +++++++++++++
 data/pam-ataraxia/gdm-launch-environment.pam | 13 +++++++++++++
 data/pam-ataraxia/gdm-password.pam           | 11 +++++++++++
 data/pam-ataraxia/gdm-pin.pam                | 13 +++++++++++++
 data/pam-ataraxia/gdm-smartcard.pam          | 13 +++++++++++++
 meson.build                                  |  1 +
 meson_options.txt                            |  2 +-
 9 files changed, 86 insertions(+), 1 deletion(-)
 create mode 100644 data/pam-ataraxia/gdm-autologin.pam
 create mode 100644 data/pam-ataraxia/gdm-fingerprint.pam
 create mode 100644 data/pam-ataraxia/gdm-launch-environment.pam
 create mode 100644 data/pam-ataraxia/gdm-password.pam
 create mode 100644 data/pam-ataraxia/gdm-pin.pam
 create mode 100644 data/pam-ataraxia/gdm-smartcard.pam

diff --git a/data/meson.build b/data/meson.build
index 05a2011..9b749a3 100644
--- a/data/meson.build
+++ b/data/meson.build
@@ -137,6 +137,14 @@ pam_data_files_map = {
     'gdm-password',
     'gdm-pin',
   ],
+  'ataraxia': [
+    'gdm-autologin',
+    'gdm-launch-environment',
+    'gdm-fingerprint',
+    'gdm-smartcard',
+    'gdm-password',
+    'gdm-pin',
+  ],
   'none': [],
   # We should no longer have 'autodetect' at this point
 }
diff --git a/data/pam-ataraxia/gdm-autologin.pam b/data/pam-ataraxia/gdm-autologin.pam
new file mode 100644
index 0000000..99b1420
--- /dev/null
+++ b/data/pam-ataraxia/gdm-autologin.pam
@@ -0,0 +1,13 @@
+auth     requisite pam_nologin.so
+auth     required  pam_env.so
+auth     optional  pam_gdm.so
+auth     optional  pam_gnome_keyring.so
+auth     optional  pam_permit.so
+
+account  include   system-local-login
+
+password include   system-local-login
+
+session  optional  pam_keyinit.so force revoke
+session  include   system-local-login
+session  optional  pam_gnome_keyring.so auto_start
diff --git a/data/pam-ataraxia/gdm-fingerprint.pam b/data/pam-ataraxia/gdm-fingerprint.pam
new file mode 100644
index 0000000..7490ec5
--- /dev/null
+++ b/data/pam-ataraxia/gdm-fingerprint.pam
@@ -0,0 +1,13 @@
+auth     required  pam_shells.so
+auth     requisite pam_nologin.so
+auth     required  pam_env.so
+auth     required  pam_fprintd.so
+auth     optional  pam_permit.so
+
+account  include   system-local-login
+
+password required  pam_fprintd.so
+password optional  pam_permit.so
+
+session  optional  pam_keyinit.so force revoke
+session  include   system-local-login
diff --git a/data/pam-ataraxia/gdm-launch-environment.pam b/data/pam-ataraxia/gdm-launch-environment.pam
new file mode 100644
index 0000000..a4dfec5
--- /dev/null
+++ b/data/pam-ataraxia/gdm-launch-environment.pam
@@ -0,0 +1,13 @@
+auth     required  pam_succeed_if.so audit quiet_success user = gdm
+auth     required  pam_env.so
+auth     optional  pam_permit.so
+
+account  required  pam_succeed_if.so audit quiet_success user = gdm
+account  include   system-local-login
+
+password required  pam_deny.so
+
+session  required  pam_succeed_if.so audit quiet_success user = gdm
+session  optional  pam_keyinit.so force revoke
+-session optional  pam_systemd.so
+session  optional  pam_permit.so
diff --git a/data/pam-ataraxia/gdm-password.pam b/data/pam-ataraxia/gdm-password.pam
new file mode 100644
index 0000000..8d34794
--- /dev/null
+++ b/data/pam-ataraxia/gdm-password.pam
@@ -0,0 +1,11 @@
+auth     include   system-local-login
+auth     optional  pam_gnome_keyring.so
+
+account  include   system-local-login
+
+password include   system-local-login
+password optional  pam_gnome_keyring.so use_authtok
+
+session  optional  pam_keyinit.so force revoke
+session  include   system-local-login
+session  optional  pam_gnome_keyring.so auto_start
diff --git a/data/pam-ataraxia/gdm-pin.pam b/data/pam-ataraxia/gdm-pin.pam
new file mode 100644
index 0000000..135e205
--- /dev/null
+++ b/data/pam-ataraxia/gdm-pin.pam
@@ -0,0 +1,13 @@
+auth     requisite pam_pin.so
+auth     include   system-local-login
+auth     optional  pam_gnome_keyring.so
+
+account  include   system-local-login
+
+password include   system-local-login
+password optional  pam_pin.so
+password optional  pam_gnome_keyring.so use_authtok
+
+session  optional  pam_keyinit.so force revoke
+session  include   system-local-login
+session  optional  pam_gnome_keyring.so auto_start
diff --git a/data/pam-ataraxia/gdm-smartcard.pam b/data/pam-ataraxia/gdm-smartcard.pam
new file mode 100644
index 0000000..63569a6
--- /dev/null
+++ b/data/pam-ataraxia/gdm-smartcard.pam
@@ -0,0 +1,13 @@
+auth     required  pam_shells.so
+auth     requisite pam_nologin.so
+auth     required  pam_env.so
+auth     required  pam_pkcs11.so wait_for_card card_only
+auth     optional  pam_permit.so
+
+account  include   system-local-login
+
+password required  pam_pkcs11.so
+password optional  pam_permit.so
+
+session  optional  pam_keyinit.so force revoke
+session  include   system-local-login
diff --git a/meson.build b/meson.build
index 7e336bf..4dd78e7 100644
--- a/meson.build
+++ b/meson.build
@@ -172,6 +172,7 @@ if default_pam_config == 'autodetect'
     '/etc/exherbo-release': 'exherbo',
     '/etc/arch-release': 'arch',
     '/etc/lfs-release': 'lfs',
+    '/etc/ataraxia-release': 'ataraxia',
   }
 
   foreach _file, _pam_conf : pam_autodetect_map
diff --git a/meson_options.txt b/meson_options.txt
index 49550bc..9304372 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -2,7 +2,7 @@ option('at-spi-registryd-dir', type: 'string', value: '', description: 'Specify
 option('check-accelerated-dir', type: 'string', value: '', description: 'Specify the directory of gnome-session-check-accelerated.')
 option('custom-conf', type: 'string', value: '', description: 'Filename to give to custom configuration file.')
 option('dbus-sys', type: 'string', value: '', description: 'Where D-Bus systemd directory is.')
-option('default-pam-config', type: 'combo', choices: [ 'autodetect', 'redhat', 'openembedded', 'exherbo', 'lfs', 'arch', 'none'], value: 'autodetect', description: '')
+option('default-pam-config', type: 'combo', choices: [ 'autodetect', 'redhat', 'openembedded', 'exherbo', 'lfs', 'arch', 'ataraxia', 'none'], value: 'autodetect', description: '')
 option('default-path', type: 'string', value: '/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin', description: 'Path GDM will use as the user\'s default PATH.')
 option('defaults-conf', type: 'string', value: '', description: 'Filename to give to defaults file.')
 option('dmconfdir', type: 'string', value: '', description: 'Directory where sessions are stored.')
-- 
2.28.0

