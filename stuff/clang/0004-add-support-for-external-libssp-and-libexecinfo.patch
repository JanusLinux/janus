From c97c4e25f0172a867f269c97958bc3747663cdde Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Wed, 28 Apr 2021 09:51:45 -0700
Subject: [PATCH 4/5] add support for external libssp and libexecinfo

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 lib/Driver/ToolChains/Gnu.cpp   | 5 ++++-
 lib/Driver/ToolChains/Linux.cpp | 2 ++
 2 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/lib/Driver/ToolChains/Gnu.cpp b/lib/Driver/ToolChains/Gnu.cpp
index 1d8a3cdc..736845f7 100644
--- a/lib/Driver/ToolChains/Gnu.cpp
+++ b/lib/Driver/ToolChains/Gnu.cpp
@@ -621,8 +621,11 @@ void tools::gnutools::Linker::ConstructJob(Compilation &C, const JobAction &JA,
       if (Args.hasArg(options::OPT_fsplit_stack))
         CmdArgs.push_back("--wrap=pthread_create");
 
-      if (!Args.hasArg(options::OPT_nolibc))
+      if (!Args.hasArg(options::OPT_nolibc)) {
         CmdArgs.push_back("-lc");
+        CmdArgs.push_back("-lexecinfo");
+        CmdArgs.push_back("-lssp");
+      }
 
       // Add IAMCU specific libs, if needed.
       if (IsIAMCU)
diff --git a/lib/Driver/ToolChains/Linux.cpp b/lib/Driver/ToolChains/Linux.cpp
index 682f8e04..51c37a05 100644
--- a/lib/Driver/ToolChains/Linux.cpp
+++ b/lib/Driver/ToolChains/Linux.cpp
@@ -767,8 +767,10 @@ void Linux::AddClangSystemIncludeArgs(const ArgList &DriverArgs,
   // Add an include of '/include' directly. This isn't provided by default by
   // system GCCs, but is often used with cross-compiling GCCs, and harmless to
   // add even when Clang is acting as-if it were a system compiler.
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include");
 
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include");
 
   if (!DriverArgs.hasArg(options::OPT_nobuiltininc) && getTriple().isMusl())
-- 
2.31.1

