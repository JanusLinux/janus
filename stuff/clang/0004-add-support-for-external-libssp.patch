From 673ed647be2ec36b03f84abb5e971e04e8a59788 Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Sat, 17 Apr 2021 12:34:19 -0700
Subject: [PATCH 4/5] add support for external libssp

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 lib/Driver/ToolChains/Linux.cpp | 7 +++++++
 1 file changed, 7 insertions(+)

diff --git a/lib/Driver/ToolChains/Linux.cpp b/lib/Driver/ToolChains/Linux.cpp
index 682f8e04..d960af62 100644
--- a/lib/Driver/ToolChains/Linux.cpp
+++ b/lib/Driver/ToolChains/Linux.cpp
@@ -355,6 +355,11 @@ Linux::Linux(const Driver &D, const llvm::Triple &Triple, const ArgList &Args)
 
   addPathIfExists(D, SysRoot + "/lib", Paths);
   addPathIfExists(D, SysRoot + "/usr/lib", Paths);
+
+  if ((!Args.hasArg(options::OPT_nostdlib) || !Args.hasArg(options::OPT_nodefaultlibs)) && 
+  	Triple.isMusl()) {
+    ExtraOpts.push_back("-lssp");
+  }
 }
 
 ToolChain::CXXStdlibType Linux::GetDefaultCXXStdlibType() const {
@@ -767,8 +772,10 @@ void Linux::AddClangSystemIncludeArgs(const ArgList &DriverArgs,
   // Add an include of '/include' directly. This isn't provided by default by
   // system GCCs, but is often used with cross-compiling GCCs, and harmless to
   // add even when Clang is acting as-if it were a system compiler.
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include");
 
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include");
 
   if (!DriverArgs.hasArg(options::OPT_nobuiltininc) && getTriple().isMusl())
-- 
2.31.0

