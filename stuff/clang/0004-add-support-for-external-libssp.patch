From 57a962d09f1d33a6dcd1500c5bcefe5a7ed65ebd Mon Sep 17 00:00:00 2001
From: Ishimoto Shinobu <nagakamira@gmail.com>
Date: Sun, 18 Apr 2021 06:59:48 -0700
Subject: [PATCH 4/5] add support for external libssp

Signed-off-by: Ishimoto Shinobu <nagakamira@gmail.com>
---
 lib/Driver/ToolChains/Gnu.cpp   | 4 +++-
 lib/Driver/ToolChains/Linux.cpp | 2 ++
 2 files changed, 5 insertions(+), 1 deletion(-)

diff --git a/lib/Driver/ToolChains/Gnu.cpp b/lib/Driver/ToolChains/Gnu.cpp
index 1d8a3cdc..a2abd389 100644
--- a/lib/Driver/ToolChains/Gnu.cpp
+++ b/lib/Driver/ToolChains/Gnu.cpp
@@ -621,8 +621,10 @@ void tools::gnutools::Linker::ConstructJob(Compilation &C, const JobAction &JA,
       if (Args.hasArg(options::OPT_fsplit_stack))
         CmdArgs.push_back("--wrap=pthread_create");
 
-      if (!Args.hasArg(options::OPT_nolibc))
+      if (!Args.hasArg(options::OPT_nolibc)) {
         CmdArgs.push_back("-lc");
+        CmdArgs.push_back("-lssp");
+      }
 
       // Add IAMCU specific libs, if needed.
       if (IsIAMCU)
diff --git a/lib/Driver/ToolChains/Linux.cpp b/lib/Driver/ToolChains/Linux.cpp
index 682f8e04..51c37a05 100644
--- a/lib/Driver/ToolChains/Linux.cpp
+++ b/lib/Driver/ToolChains/Linux.cpp
@@ -767,8 +767,10 @@ void Linux::AddClangSystemIncludeArgs(const ArgList &DriverArgs,
   // Add an include of '/include' directly. This isn't provided by default by
   // system GCCs, but is often used with cross-compiling GCCs, and harmless to
   // add even when Clang is acting as-if it were a system compiler.
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/include");
 
+  addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include/secure");
   addExternCSystemInclude(DriverArgs, CC1Args, SysRoot + "/usr/include");
 
   if (!DriverArgs.hasArg(options::OPT_nobuiltininc) && getTriple().isMusl())
-- 
2.31.0

