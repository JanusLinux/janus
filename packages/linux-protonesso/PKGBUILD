# Maintainer: protonesso <nagakamira@gmail.com>

pkgname=linux-protonesso
pkgver=4.17
pkgrel=1
arch=('x86_64' 'aarch64')
url="https://www.kernel.org/"
license=('GPL')
groups=('base')
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-$pkgver.tar.xz")

build() {
	cd "$srcdir/linux-$pkgver"
	unset LDFLAGS
	make mrproper

	msg "Generating Linux kernel config"
	make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- defconfig

cat >> .config << EOF
CONFIG_PCI=y
CONFIG_PRINTK=y
CONFIG_TTY=y
CONFIG_SLOB=y
CONFIG_BINFMT_ELF=y
CONFIG_BINFMT_SCRIPT=y
CONFIG_DEFAULT_HOSTNAME="protonesso"
CONFIG_CC_OPTIMIZE_FOR_SIZE=y
CONFIG_PROC_FS=y
CONFIG_SYSFS=y
CONFIG_TMPFS=y
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_FILE_LOCKING=y
CONFIG_SATA_AHCI=y
CONFIG_BLK_DEV_SD=y
CONFIG_EXT4_FS=y
CONFIG_DEVTMPFS=y
CONFIG_UNWINDER_FRAME_POINTER=y
CONFIG_EFI=y
CONFIG_EFI_STUB=y
CONFIG_EFI_PARTITION=y
CONFIG_FB_EFI=y
CONFIG_FRAMEBUFFER_CONSOLE=y
CONFIG_EFI_VARS=y
CONFIG_EFI_RUNTIME_MAP=y
CONFIG_EFIVAR_FS=y
CONFIG_SOUND=y
CONFIG_SND=y
CONFIG_AUTOFS4_FS=y
CONFIG_NETWORK_FILESYSTEMS=y
CONFIG_NFS_FS=y
CONFIG_CIFS=y
CONFIG_NET=y
CONFIG_BT=y
CONFIG_BT_RFCOMM=y
CONFIG_BT_RFCOMM_TTY=y
CONFIG_BT_BNEP=y
CONFIG_BT_BNEP_MC_FILTER=y
CONFIG_BT_BNEP_PROTO_FILTER=y
CONFIG_BT_HIDP=y
CONFIG_NET=y
CONFIG_CRYPTO=y
CONFIG_CRYPTO_USER_API_HASH=y
CONFIG_CRYPTO_USER_API_SKCIPHER=y
CONFIG_SERIAL_8250=y
CONFIG_SERIAL_8250_CONSOLE=y
CONFIG_HWMON=y
CONFIG_VIRTIO=y
CONFIG_VIRTIO_RING=y
CONFIG_VIRTIO_PCI=y
CONFIG_VIRTIO_PCI_LEGACY=y
CONFIG_VIRTIO_MMIO=y
CONFIG_VIRTIO_CONSOLE=y
CONFIG_VIRTIO_BLK=y
CONFIG_VIRTIO_NET=y
CONFIG_NET=y
CONFIG_INET=y
CONFIG_NET_9P=y
CONFIG_NET_9P_DEBUG=y
CONFIG_NET_9P_VIRTIO=y
CONFIG_9P_FS=y
CONFIG_9P_FS_POSIX_ACL=y
CONFIG_MULTIUSER=y
CONFIG_BLOCK=y
# CONFIG_LBDAF is not set
# CONFIG_BLK_DEV_BSG is not set
# CONFIG_IOSCHED_CFQ is not set
CONFIG_BRIDGE=y
CONFIG_BTRFS_FS=y
CONFIG_PACKET=y
CONFIG_MEDIA_CAMERA_SUPPORT=y
CONFIG_MEDIA_USB_SUPPORT=y
CONFIG_CIFS=y
CONFIG_MD=y
CONFIG_BLK_DEV_DM=y
CONFIG_DM_CRYPT=y
CONFIG_CRYPTO_XTS=y
CONFIG_CRYPTO_SHA256=y
CONFIG_CRYPTO_AES=y
CONFIG_CRYPTO_AES_X86_64=y
CONFIG_CRYPTO_USER_API_SKCIPHER=y
CONFIG_USB_SUPPORT=y
CONFIG_USB_OHCI_HCD=y
CONFIG_USB_UHCI_HCD=y
CONFIG_USB_PRINTER=y
CONFIG_PARPORT=y
CONFIG_PARPORT_PC=y
CONFIG_PRINTER=y
CONFIG_IPV6=y
CONFIG_FUSE_FS=y
CONFIG_NETFILTER=y
CONFIG_JFS_FS=y
CONFIG_INPUT=y
CONFIG_INPUT_EVDEV=y
CONFIG_INPUT_MISC=y
CONFIG_INPUT_UINPUT=y
CONFIG_MODULES=y
CONFIG_I2C_CHARDEV=y
CONFIG_DM_SNAPSHOT=y
CONFIG_DM_THIN_PROVISIONING=y
CONFIG_DM_MIRROR=y
CONFIG_MAGIC_SYSRQ=y
CONFIG_BLK_DEV_MD=y
CONFIG_MD_AUTODETECT=y
CONFIG_MD_LINEAR=y
CONFIG_MD_RAID0=y
CONFIG_MD_RAID1=y
CONFIG_MD_RAID10=y
CONFIG_MD_RAID456=y
CONFIG_NFSD=y
CONFIG_SUSPEND=y
CONFIG_HIBERNATION=y
CONFIG_VIRTUALIZATION=y
CONFIG_KVM=y
CONFIG_KVM_INTEL=y
CONFIG_KVM_AMD=y
CONFIG_BRIDGE=y
CONFIG_NETDEVICES=y
CONFIG_TUN=y
CONFIG_REISERFS_FS=y
CONFIG_DNOTIFY=y
CONFIG_USB=y
CONFIG_DRIVER_WEXT=y
CONFIG_CTRL_IFACE=y
CONFIG_BACKEND=file
CONFIG_DRIVER_MADWIFI=y
CONFIG_WIRELESS=y
CONFIG_CFG80211=y
CONFIG_CFG80211_WEXT=y
CONFIG_MAC80211=y
CONFIG_NETDEVICES=y
CONFIG_WLAN=y
CONFIG_XFS_FS=y
CONFIG_DRM=y
CONFIG_DRM_AMDGPU=y
CONFIG_DRM_AMDGPU_SI=y
CONFIG_DRM_AMDGPU_CIK=y
CONFIG_DRM_RADEON=y
CONFIG_DRM_I915=y
CONFIG_DRM_NOUVEAU=y
CONFIG_DRM_NOUVEAU_BACKLIGHT=y
CONFIG_DRM_VMWGFX=y
CONFIG_DRM_VMWGFX_FBCON=y
CONFIG_HID=y
CONFIG_HID_WACOM=y
CONFIG_PCI_MSI=y
CONFIG_HAVE_KERNEL_GZIP=y
CONFIG_HAVE_KERNEL_BZIP2=y
CONFIG_HAVE_KERNEL_LZMA=y
CONFIG_HAVE_KERNEL_XZ=y
CONFIG_HAVE_KERNEL_LZO=y
CONFIG_HAVE_KERNEL_LZ4=y
CONFIG_KERNEL_GZIP=y
CONFIG_UNWINDER_FRAME_POINTER=y
CONFIG_IDEAPAD_LAPTOP=y
CONFIG_IDEAPAD_SLIDEBAR=y
CONFIG_INIT_ENV_ARG_LIMIT=32
CONFIG_KERNEL_XZ=y
# CONFIG_KERNEL_GZIP is not set
# CONFIG_KERNEL_BZIP2 is not set
# CONFIG_KERNEL_LZMA is not set
# CONFIG_KERNEL_LZO is not set
# CONFIG_KERNEL_LZ4 is not set
CONFIG_FB_VESA=y
# CONFIG_DEBUG_KERNEL is not set
CONFIG_RESET_ATTACK_MITIGATION=y
CONFIG_8139TOO=y
CONFIG_8139CP=y
CONFIG_SQUASHFS=y
CONFIG_CGROUPS=y
CONFIG_EVENTFD=y
CONFIG_CGROUP_DEVICE=y
CONFIG_CPUSETS=y
CONFIG_CGROUP_CPUACCT=y
CONFIG_PAGE_COUNTER=y
CONFIG_MEMCG=y
CONFIG_MEMCG_SWAP=y
CONFIG_MEMCG_SWAP_ENABLED=y
CONFIG_CGROUP_PERF=y
CONFIG_CGROUP_SCHED=y
CONFIG_CGROUP_HUGETLB=y
CONFIG_FAIR_GROUP_SCHED=y
CONFIG_CFS_BANDWIDTH=y
CONFIG_RT_GROUP_SCHED=y
CONFIG_BLK_CGROUP=y
CONFIG_SQUASHFS_FILE_CACHE=y
CONFIG_SQUASHFS_DECOMP_SINGLE=y
CONFIG_SQUASHFS_ZLIB=y
CONFIG_DRM_VIRTIO_GPU=y
CONFIG_DEBUG_BLK_CGROUP=n
CONFIG_BLK_DEV_THROTTLING=n
CONFIG_CFQ_GROUP_IOSCHED=n
CONFIG_HW_RANDOM_VIRTIO=n
CONFIG_VIRTIO_BALLOON=n
CONFIG_VIRTIO_INPUT=n
CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES=n
CONFIG_SQUASHFS_XATTR SQUASHFS_LZ4=n
CONFIG_SQUASHFS_LZO=n
CONFIG_SQUASHFS_XZ=n
CONFIG_SQUASHFS_4K_DEVBLK_SIZE=n
CONFIG_SQUASHFS_EMBEDDED=n
CONFIG_SQUASHFS_FILE_DIRECT=n
CONFIG_SQUASHFS_DECOMP_MULTI=n
CONFIG_SQUASHFS_DECOMP_MULTI_PERCPU=n
CONFIG_EXT2_FS=y
CONFIG_EXT3_FS=y
CONFIG_VFAT_FS=y
CONFIG_PPP=y
CONFIG_PPP_ASYNC=y
CONFIG_PPP_SYNC_TTY=y
CONFIG_HID_GENERIC=y
CONFIG_USB_HID=y
CONFIG_USB_XHCI_HCD=y
CONFIG_USB_EHCI_HCD=y
CONFIG_USB_OHCI_HCD=y
CONFIG_PARTITION_ADVANCED=y
CONFIG_EFI_MIXED=y
CONFIG_ATA_SFF=y
CONFIG_PATA_PLATFORM=y
CONFIG_PATA_LEGACY=y
CONFIG_PATA_ACPI=y
CONFIG_SMP=y
EOF

	case $CARCH in
		x86_64)
			echo "CONFIG_IA32_EMULATION=y" >> .config
			;;
	esac

	yes '' | make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- silentoldconfig
	yes '' | make ARCH=$XKARCH CROSS_COMPILE=$XTARGET-
}

package() {
	cd "$srcdir/linux-$pkgver"
	make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- INSTALL_MOD_PATH=$pkgdir/usr modules_install

	mkdir -p $pkgdir/boot
	case $CARCH in
		x86_64)
			cp arch/x86/boot/bzImage $pkgdir/boot/vmlinuz
			;;
		aarch64)
			cp arch/arm64/boot/Image $pkgdir/boot/vmlinuz
			;;
	esac
}
