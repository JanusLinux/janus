# Description: A replacement for sysvinit, and other init schemes, with service supervision
# URL:         http://smarden.org/runit/
# Maintainer:  protonesso, nagakamira at gmail dot com

name=runit
version=2.1.2
release=2
source=(http://smarden.org/$name/$name-$version.tar.gz
	halt.c
	1
	2
	3
	tty1
	tty1-finish
	tty2
	tty2-finish
	tty3
	tty3-finish
	tty4
	tty4-finish
	tty5
	tty5-finish
	tty6
	tty6-finish
	ttyS0
	ttyS0-finish)

build() {
	cd admin/$name-$version

	sed -e 's,sbin/runit,usr/bin/runit,g' -i src/runit.h
	sed -i -e 's:^char \*varservice ="/service/";$:char \*varservice ="/var/service/";:' src/sv.c
	sed -i -e 's:short x\[4\];$:gid_t x[4];:' src/chkshsgr.c
	echo "${CC:-gcc} $CFLAGS -static" > src/conf-cc
	echo "${CC:-gcc -s} $LDFLAGS -static" > src/conf-ld

	make -C src

	install -dm0755 $PKG/usr/bin

	for f in $(<package/commands); do
		install -sm0755 src/$f $PKG/usr/bin
	done

	install -dm0755 $PKG/etc/sv
	install -dm0755 $PKG/etc/runit/runsvdir/current
	install -dm0755 $PKG/var

	ln -sf /etc/runit/runsvdir/current $PKG/var/service

	install -m0755 $SRC/{1,2,3} $PKG/etc/runit/
	install -m0755 etc/debian/ctrlaltdel $PKG/etc/runit/

	for tty in tty1 tty2 tty3 tty4 tty5 tty6 ttyS0; do
		install -D -m755 $SRC/$tty $PKG/etc/sv/$tty/run
		install -D -m755 $SRC/$tty-finish $PKG/etc/sv/$tty/finish
		ln -sf /etc/sv/$tty $PKG/etc/runit/runsvdir/current/$tty
	done

	cc $CFLAGS $SRC/halt.c -o $SRC/halt $LDFLAGS

	install -D -m755 $SRC/halt $PKG/usr/bin/halt
	ln -sf halt $PKG/usr/bin/poweroff
	ln -sf halt $PKG/usr/bin/reboot

	clean-package $PKG
}
