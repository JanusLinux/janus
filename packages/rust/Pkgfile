# Description: Systems programming language focused on safety, speed and concurrency
# URL:         https://www.rust-lang.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  curl cmake libssh2 llvm python libffi ncurses libxml2 zlib libgit2 http-parser

name=rust
version=nightly
distver=1.28.0
release=20181101
source=(https://static.rust-lang.org/dist/rustc-$version-src.tar.gz)

build() {
	export SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
	export LD_LIBRARY_PATH="$(pwd)/stage0/lib"
	export PATH="$(pwd)/stage0/bin:$PATH"
	export MUSL_ROOT=/usr
	export RUST_BACKTRACE=1
	export RUSTFLAGS="-C linker=gcc"

	case $BARCH in
		x86_64)
			export RTARGET="x86_64-unknown-linux-musl"
			;;
		aarch64)
			export RTARGET="aarch64-unknown-linux-musl"
			;;
		armv7h)
			export RTARGET="armv7-unknown-linux-musleabihf"
			;;
		armv6h)
			export RTARGET="arm-unknown-linux-musleabihf"
			;;
		*)
			echo "Unsupported architecure!"
			exit 1
	esac

	mkdir -p stage0

	wget https://portage.smaeul.xyz/distfiles/rust-$distver-$RTARGET.tar.xz
	tar -xf rust-$distver-$RTARGET.tar.xz
	rust-$distver-$RTARGET/install.sh" \
		--destdir="$(pwd)/stage0" \
		--prefix=/ \
		--components=rust-std-$RTARGET,rustc,cargo \
		--disable-ldconfig

	cd rustc-$version-src
	patch -Np1 -i $KEEP/rust/libunwind.patch
	patch -Np1 -i $KEEP/rust/link-musl-dynamically.patch
	patch -Np1 -i $KEEP/rust/llvm-with-ffi.patch
	patch -Np1 -i $KEEP/rust/musl-dont-use-crt-static.patch
	patch -Np1 -i $KEEP/rust/use-correct-llvm-when-cross.patch

	sed -i /LD_LIBRARY_PATH/d src/bootstrap/bootstrap.py

	rm -rf src/llvm

	./configure \
		--prefix=/usr \
		--host=$RTARGET \
		--target=$RTARGET \
		--build=$XTARGET \
		--disable-docs \
		--release-channel=nightly \
		--disable-codegen-tests \
		--disable-full-bootstrap \
		--disable-jemalloc \
		--disable-rpath \
		--llvm-root=/usr \
		--set=target.$RTARGET.llvm-config=/usr/bin/llvm-config \
		--set=target.$RTARGET.musl-root=/usr \
		--local-rust-root=$(pwd)/../stage0
	python3 x.py build -v --jobs ${JOBS:-2}
	DESTDIR=$PKG python3 x.py install -v

	chown -R root:root $PKG/*

	echo "Stripping $name package..."
	find $PKG -type f | xargs file 2>/dev/null | grep "LSB executable"       | cut -f 1 -d : | xargs $STRIP --strip-all			2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "shared object"        | cut -f 1 -d : | xargs $STRIP --strip-unneeded		2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "current ar archive"   | cut -f 1 -d : | xargs $STRIP --strip-debug			2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "libtool library file" | cut -f 1 -d : | xargs rm -rf					2>/dev/null || true
	cd $PKG
	rm -rf {,usr/}{,local/}{,share/}{doc,man,info,locale} usr{,/local}{,/share},opt/*}/{man,info} usr/{,local/}{,share/}{doc,gtk-doc} opt/*/{doc,gtk-doc}
	rm -rf {,usr/}lib/charset.alias
}
