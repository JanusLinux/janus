# Description: Systems programming language focused on safety, speed and concurrency
# URL:         https://www.rust-lang.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Section:     devel

name=rust
version=1.45.2
release=2
options=('~emptydirs')
source=("https://static.rust-lang.org/dist/rust-$version-x86_64-unknown-linux-musl.tar.xz")

build() {
	case $BARCH in
		x86_64)
			export RTARGET="x86_64-unknown-linux-musl"
			;;
		*)
			echo "Architecture is not set or is not supported by Rust Language"
			exit 1
	esac

	mkdir -p "$SRC"/rust
	pushd "$SRC"/rust-$version-$RTARGET
		sed -i 's.\\-.-.g' install.sh
		sed -i 's.\\_._.g' install.sh
		bash install.sh \
			--prefix=/usr \
			--destdir="$PKG" \
			--disable-ldconfig
	popd

	cd "$PKG"/usr/lib

	rm -rf rustlib/{components,manifest-rustc,rust-installer-version}
	ln -sf rustlib/$RTARGET/lib/*.so .

	install -d "$PKG"/usr/share/bash-completion
	mv "$PKG"/usr/etc/bash_completion.d/ "$PKG"/usr/share/bash-completion/completions/
	rm -rf "$PKG"/usr/etc

	mv "$PKG"/usr/bin/rustc "$PKG"/usr/bin/rustc.real
	cat > "$PKG"/usr/bin/rustc <<-EOF
		#!/usr/bin/sh
		/usr/bin/rustc.real -C target-feature=-crt-static $@
	EOF
	chmod +x "$PKG"/usr/bin/rustc
}
