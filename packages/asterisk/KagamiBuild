# Description: Open Source Private Branch Exchange
# URL:         https://www.asterisk.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  alsa-lib curl gsm jansson libedit libvorbis libxslt opus popt speexdsp sqlite bluez libcap lua newt pjproject unbound portaudio
# Section:     comm

name=asterisk
version=18.3.0
release=2
factory=("/etc/asterisk::NULL::C::0755::asterisk::asterisk"
	"/etc/logrotate.d/asterisk::NULL::C"
	"/var/lib/asterisk::NULL::C::0755::asterisk::asterisk"
	"/var/log/asterisk::NULL::C::0755::asterisk::asterisk"
	"/var/spool/asterisk::NULL::C::0755::asterisk::asterisk"
	"/run/asterisk::NULL::d::0755::asterisk::asterisk")
source=("https://downloads.asterisk.org/pub/telephony/asterisk/releases/$name-$version.tar.gz")

build() {
	append-cflags "-I$STUFF/include"
	append-cxxflags "-I$STUFF/include"

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/asterisk/10-musl-mutex-init.patch
	patch -Np1 -i "$STUFF"/asterisk/20-musl-astmm-fix.patch
	patch -Np1 -i "$STUFF"/asterisk/40-asterisk-cdefs.patch	

	./configure $BUILDFLAGS \
		--prefix=/usr \
		--sbindir=/usr/bin \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--without-pjproject-bundled
	make menuselect.makeopts

	./menuselect/menuselect \
		--enable chan_mobile \
		--enable app_meetme \
		--enable IMAP_STORAGE \
		--disable BUILD_NATIVE \
		menuselect.makeopts

	make
	make -j1 DESTDIR="$PKG" install install-headers

	for i in configs/samples/*.sample; do
		a="$(basename $i)"
		b="${a%*.sample}"
		install -Dm644 $i "$PKG"/etc/asterisk/$b
	done

	rm -rf "$PKG"/var/run
	sed -i -e 's,/var/run,/run,' "$PKG"/etc/asterisk/asterisk.conf

	install -d "$PKG"/var/lib/asterisk

	for i in contrib/systemd/asterisk.service contrib/systemd/*.socket; do
		install -Dm644 $i "$PKG"/usr/lib/systemd/system/$(basename $i)
	done
	install -Dm644 "$STUFF"/sysusers.d/asterisk.conf "$PKG"/usr/lib/sysusers.d/asterisk.conf
	install -Dm644 "$STUFF"/asterisk/logrotate "$PKG"/etc/logrotate.d/asterisk
}
