# Description: Size optimized toolbox of many common UNIX utilities
# URL:         https://www.busybox.net/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Section:     base

name=busybox
version=1.32.1
release=1
source=("http://busybox.net/downloads/$name-$version.tar.bz2")

build() {
	case "$BARCH" in
		amd64) export KARCH="x86_64" ;;
		x86) export KARCH="i386" ;;
		arm64) export KARCH="arm64" ;;
		armv7l) export KARCH="arm" ;;
		armv6l) export KARCH="arm" ;;
		armv5te) export KARCH="arm" ;;
		mips64) export KARCH="mips" ;;
		mips64el) export KARCH="mips" ;;
		mips) export KARCH="mips" ;;
		mipsel) export KARCH="mips" ;;
		powerpc64le) export KARCH="powerpc" ;;
		powerpc64) export KARCH="powerpc" ;;
		riscv64) export KARCH="riscv" ;;
		*) die 'Architecture called `'${BARCH}'` is not supported by Ataraxia Linux' ;;
	esac

	cd "$SRC"/$name-$version
	if [ "$USEBOOTSTRAP" = "yes" ]; then
		make ARCH=$KARCH CROSS_COMPILE=${CROSS_COMPILE} CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS" defconfig
	else
		make ARCH=$KARCH CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS" defconfig
	fi

	sed -i 's/\(CONFIG_FEATURE_WTMP\)=y/# \1 is not set/' .config
	sed -i 's/\(CONFIG_FEATURE_UTMP\)=y/# \1 is not set/' .config

	if [ "$USEBOOTSTRAP" = "yes" ]; then
		make ARCH=$KARCH CROSS_COMPILE=${CROSS_COMPILE} CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS"
		make ARCH=$KARCH CROSS_COMPILE=${CROSS_COMPILE} CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS" busybox.links
	else
		make ARCH=$KARCH CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS"
		make ARCH=$KARCH CC=${CROSS_COMPILE}clang EXTRA_CFLAGS="$CFLAGS" busybox.links
	fi

	install -Dm755 busybox "$PKG"/usr/bin/busybox
}
