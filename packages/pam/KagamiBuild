# Description: Pluggable Authentication Modules
# URL:         http://linux-pam.org
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  cracklib
# Section:     security

name=pam
version=1.4.0
release=7
options=('~emptydirs' 'bootstrap')
source=("https://github.com/linux-pam/linux-pam/releases/download/v$version/Linux-PAM-$version.tar.xz")

build() {
	cd "$SRC"/Linux-PAM-$version
	patch -Np1 -i "$STUFF"/pam/0001-fix-build-on-musl.patch

	export ac_cv_search_crypt=no

	./configure $BUILDFLAGS \
		--prefix=/usr \
		--libdir=/usr/lib \
		--sbindir=/usr/bin \
		--disable-audit \
		--disable-db \
		--disable-nls \
		--disable-regenerate-docu \
		--disable-selinux
	make
	make DESTDIR="$PKG" install

	rm -rf "$PKG"/usr/lib/security/*.a "$PKG"/var/run

	chmod 4755 "$PKG"/usr/bin/unix_chkpwd

	pushd "$PKG"
		mkdir -p usr/share/factory
		mv etc usr/share/factory

		install -Dm644 "$STUFF"/stateless.d/pam.conf usr/lib/tmpfiles.d/stateless-pam.conf
	popd

	for pam in system-auth system-local-login system-login system-remote-login system-services other; do
		install -Dm644 "$STUFF"/pam.d/$pam "$PKG"/usr/share/factory/etc/pam.d/$pam
	done
}
