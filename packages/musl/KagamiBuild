# Description: The standard C library
# URL:         http://www.musl-libc.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Section:     base

name=musl
version=1.2.2
release=1
options=('bootstrap')
source=("http://www.musl-libc.org/releases/$name-$version.tar.gz")

build() {
	export CFLAGS="${CFLAGS/-flto/}"
	export CFLAGS="${CFLAGS/-fvisibility=hidden/}"
	export CFLAGS="${CFLAGS/-fsanitize=cfi/}"
	export CFLAGS="${CFLAGS/-fsanitize-cfi-cross-dso/}"

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/musl/0001-Implement-LLVM-SafeStack.patch

	./configure $TOOLFLAGS \
		--prefix=/usr \
		--syslibdir=/usr/lib \
		--enable-optimize=size
	make
	make DESTDIR="$PKG" install

	install -d "$PKG"/usr/bin
	ln -sf ../lib/libc.so "$PKG"/usr/bin/ldd
}
