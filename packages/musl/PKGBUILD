# Maintainer: Protonesso <nagakamira@gmail.com>

pkgname=musl
pkgver=1.1.18
pkgrel=1
pkgdesc="C standard library"
arch=('i686' 'x86_64' 'armv7h' 'aarch64')
url="http://www.musl-libc.org/"
license=('MIT')
groups=('basic')
depends=('linux-headers')
source=("http://www.musl-libc.org/releases/$pkgname-$pkgver.tar.gz")
md5sums=('SKIP')

build() {
        cd $srcdir/$pkgname-$pkgver

	export BCONF="--prefix=/usr --libdir=/usr/lib --libexecdir=/usr/libexec --bindir=/usr/bin --sbindir=/usr/bin --sysconfdir=/etc --localstatedir=/var"

	use_crosscompile() {
		export PATH="$TOOLS/bin:$PATH"

		export BHOST="$(echo ${MACHTYPE} | sed -e 's/-[^-]*/-cross/')"

		[[ $arch == "i686" ]] && export BTARGET="i686-linux-musl"
		[[ $arch == "x86_64" ]] && export BTARGET="x86_64-linux-musl"
		[[ $arch == "armv7h" ]] && export BTARGET="arm-linux-musleabihf"
		[[ $arch == "aarch64" ]] && export BTARGET="aarch64-linux-musl"

		export CC="$BTARGET-gcc --sysroot=$ROOTFS"
		export CXX="$BTARGET-g++ --sysroot=$ROOTFS"
		export AR="$BTARGET-ar"
		export AS="$BTARGET-as"
		export LD="$BTARGET-ld --sysroot=$ROOTFS"
		export RANLIB="$BTARGET-ranlib"
		export READELF="$BTARGET-readelf"
		export STRIP="$BTARGET-strip"

		export BCONF="$BCONF --build=$BHOST --host=$BTARGET"

		export CROSS_COMPILE="$BTARGET-"
	}

	[[ $CROSSCOMPILE == "YES" ]] && use_crosscompile

        ./configure \
		$BCONF \
		--enable-optimize
        make
}

package() {
        cd $srcdir/$pkgname-$pkgver

        make DESTDIR=$pkgdir install
}
