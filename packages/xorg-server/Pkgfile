# Description: Xorg X server
# URL:         https://xorg.freedesktop.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  util-linux busybox libepoxy tslib bdftopcf font-util libdmx libxaw libxcomposite libxcursor libxfont2 libxft libxinerama libxkbfile libxrandr libxres libxtst libxxf86dga mkfontdir mkfontscale xcb-util-keysyms xorg-fonts xkeyboard-config pixman wayland-protocols

name=xorg-server
version=1.20.0
release=1
source=(https://www.x.org/pub/individual/xserver/$name-$version.tar.bz2)

build() {
	cd $name-$version
	sed -i '/^#include <asm\/page.h>/d' Xext/xf86bigfont.c
	./configure CPPFLAGS="-D_GNU_SOURCE -D__gid_t=gid_t -D__uid_t=uid_t" \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-default-font-path="/usr/share/fonts/X11/misc,/usr/share/fonts/X11/Type1,/usr/share/fonts/X11/100dpi:unscaled,/usr/share/fonts/X11/75dpi:unscaled,/usr/share/fonts/X11/cyrillic,/usr/share/fonts/X11/TTF,/usr/share/fonts/X11/OTF" \
		--with-fontrootdir=/usr/share/fonts/X11 \
		--with-module-dir=/usr/lib/xorg/modules \
		--with-xkb-path=/etc/X11/xkb \
		--with-xkb-output=/var/lib/xkb \
		--with-sha1=libcrypto \
		--enable-dmx \
		--enable-dri \
		--enable-dri2 \
		--enable-dri3 \
		--enable-glamor \
		--enable-install-setuid \
		--enable-kdrive \
		--enable-suid-wrapper \
		--enable-tslib \
		--enable-xcsecurity \
		--enable-xf86bigfont \
		--disable-config-udev \
		--disable-systemd-logind \
		--disable-xfake
	make
	make DESTDIR=$PKG install

	install -m 755 -d $PKG/etc/X11/xorg.conf.d

	echo "Stripping $name package..."
	find $PKG -type f | xargs file 2>/dev/null | grep "LSB executable"       | cut -f 1 -d : | xargs $STRIP --strip-all			2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "shared object"        | cut -f 1 -d : | xargs $STRIP --strip-unneeded		2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "current ar archive"   | cut -f 1 -d : | xargs $STRIP --strip-debug			2>/dev/null || true
	find $PKG -type f | xargs file 2>/dev/null | grep "libtool library file" | cut -f 1 -d : | xargs rm -rf					2>/dev/null || true
	cd $PKG
	rm -rf {,usr/}{,local/}{,share/}{doc,man,info,locale} usr{,/local}{,/share},opt/*}/{man,info} usr/{,local/}{,share/}{doc,gtk-doc} opt/*/{doc,gtk-doc}
	rm -rf {,usr/}lib/charset.alias
}
