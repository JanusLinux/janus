# Description: SELinux policy core utilities
# URL:         https://github.com/SELinuxProject/selinux/wiki
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  pam libsemanage
# Section:     security

name=policycoreutils
version=3.1
release=1
options=('bootstrap')
source=("https://github.com/SELinuxProject/selinux/releases/download/20200710/$name-$version.tar.gz")

build() {
	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/policycoreutils/0001-add-internal-fts-implementation.patch
	patch -Np1 -i "$STUFF"/policycoreutils/0002-fix-bashisms.patch
	patch -Np1 -i "$STUFF"/policycoreutils/0003-ataraxia-kernel-fix.patch

	if [ "$USEBOOTSTRAP" = "yes" ]; then
		make HOSTCC="$HOSTCC" CC="$CC" CFLAGS="$CFLAGS" 
		make HOSTCC="$HOSTCC" CC="$CC" CFLAGS="$CFLAGS" DESTDIR="$PKG" LIBEXECDIR=/usr/lib SBINDIR=/usr/bin install
	else
		make CFLAGS="$CFLAGS"
		make CFLAGS="$CFLAGS" DESTDIR="$PKG" LIBEXECDIR=/usr/lib SBINDIR=/usr/bin install
	fi

	install -Dm755 "$STUFF"/policycoreutils/selinux-autorelabel "$PKG"/usr/bin/selinux-autorelabel

	mkdir -p "$PKG"/usr/lib/systemd/system/sysinit.target.wants
	install -Dm644 "$STUFF"/svc/selinux-relabel.service "$PKG"/usr/lib/systemd/system/selinux-relabel.service
	ln -sf ../selinux-relabel.service "$PKG"/usr/lib/systemd/system/sysinit.target.wants/selinux-relabel.service
}
