# Description: Small and secure syslogd replacement for use with Runit
# URL:         http://smarden.org/socklog/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  runit

name=socklog
version=2.1.0
release=1
source=(http://smarden.org/$name/$name-$version.tar.gz
	headers.patch
	klog
	socklog
	socklog-check
	socklog-log)

build() {
	cd $SRC/admin/$name-$version/src
	patch -Np1 -i $SRC/headers.patch

	sed -i -e 's:^#define _PATH_KLOG "\/dev\/klog"$:#define _PATH_KLOG "\/proc\/kmsg":' socklog-conf.c

	echo "${CC:-gcc} ${CFLAGS:-O2 -Wall}" > conf-cc
	echo "${LD:-gcc -s}" > conf-ld

	make

	install -d $PKG/usr/bin
	for i in `cat $SRC/admin/$name-$version/package/commands`; do
		install -s -D -m755 $SRC/admin/$name-$version/src/$i $PKG/usr/bin
	done

	mkdir -p $PKG/etc/sv/{klog,socklog/log}
	install -D -m755 $SRC/klog $PKG/etc/sv/klog/run
	install -D -m755 $SRC/socklog-check $PKG/etc/sv/socklog/check
	install -D -m755 $SRC/socklog-log $PKG/etc/sv/socklog/log/run
	install -D -m755 $SRC/socklog $PKG/etc/sv/socklog/run

	mkdir -p $PKG/etc/runit/runsvdir/current/
	ln -sf /etc/sv/klog $PKG/etc/runit/runsvdir/current/klog
	ln -sf /etc/sv/socklog $PKG/etc/runit/runsvdir/current/socklog

	mkdir -p $PKG/var/log/socklog

	clean-package $PKG
}
