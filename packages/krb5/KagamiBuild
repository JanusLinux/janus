# Description: The Kerberos network authentication system
# URL:         https://web.mit.edu/kerberos/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  perl libressl libedit
# Section:     admin

name=krb5
version=1.18.3
case $version in
	*.*.*) _v=${version%.*};;
	*)     _v=${version};;
esac
release=1
options=('~emptydirs')
source=("https://web.mit.edu/kerberos/dist/krb5/${_v}/krb5-$version.tar.gz")

build() {
	export CFLAGS="-fPIC -DDESTRUCTOR_ATTR_WORKS=1 $CFLAGS"

	export krb5_cv_attr_constructor_destructor=yes
	export ac_cv_func_regcomp=yes
	export ac_cv_printf_positional=yes
	export ac_cv_file__etc_environment=yes
	export ac_cv_file__etc_TIMEZONE=no

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/krb5/libressl.patch

	cd src
	./configure $BUILDFLAGS \
		--prefix=/usr \
		--sbindir=/usr/bin \
		--sysconfdir=/etc \
		--localstatedir=/var/lib \
		--with-system-et=no \
		--with-system-ss=no \
		--with-system-verto=no \
		--without-tcl \
		--enable-dns-for-realm \
		--enable-shared \
		--disable-rpath
	make
	make DESTDIR="$PKG" install

	for i in kprop.service kadmin.service krb5kdc.service; do
		install -Dm644 "$STUFF"/svc/$i "$PKG"/usr/lib/systemd/system/$i
	done
	install -Dm644 "$STUFF"/tmpfiles.d/krb5.conf "$PKG"/usr/lib/tmpfiles.d/krb5.conf
}
