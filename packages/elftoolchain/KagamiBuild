# Description: BSD licensed ELF toolchain
# URL:         https://sourceforge.net/projects/elftoolchain/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  bmake libarchive
# Section:     devel

name=elftoolchain
version=r3916
release=1
source=("https://sourceforge.net/code-snapshots/svn/e/el/elftoolchain/code/elftoolchain-code-$version-trunk.zip")

build() {
	filter-flags -fomit-frame-pointer

	cd "$SRC"/elftoolchain-code-$version-trunk
	patch -Np1 -i "$STUFF"/elftoolchain/0001-fix-makefiles.patch
	patch -Np1 -i "$STUFF"/elftoolchain/0002-fix-build-on-musl-libc.patch

	mkdir -p common/sys
	cp "$STUFF"/include/sys/queue.h common/sys

	bmake WITH_TESTS=no
	bmake WITH_TESTS=no DESTDIR="$PKG" -C libelftc install
	bmake WITH_TESTS=no DESTDIR="$PKG" -C libelf install
	bmake WITH_TESTS=no DESTDIR="$PKG" -C libdwarf install
	bmake WITH_TESTS=no DESTDIR="$PKG" -C libpe install

	mkdir -p "$PKG"/usr/bin "$PKG"/usr/share/man/man1

	cp cxxfilt/c++filt "$PKG"/usr/bin/c++filt
	cp cxxfilt/c++filt.1 "$PKG"/usr/share/man/man1/c++filt.1

	cp elfcopy/mcs "$PKG"/usr/bin/mcs
	cp elfcopy/mcs.1 "$PKG"/usr/share/man/man1/mcs.1

	cp elfcopy/elfcopy "$PKG"/usr/bin/objcopy
	cp elfcopy/elfcopy.1 "$PKG"/usr/share/man/man1/objcopy.1

	cp elfcopy/strip "$PKG"/usr/bin/strip
	cp elfcopy/strip.1 "$PKG"/usr/share/man/man1/strip.1

	for i in addr2line elfcopy elfdump findtextrel nm readelf size strings; do
		cp $i/$i "$PKG"/usr/bin/$i
		cp $i/$i.1 "$PKG"/usr/share/man/man1/$i.1
	done

	cp "$STUFF"/elftoolchain/libelf.pc "$PKG"/usr/lib/pkgconfig/libelf.pc
}
