# Description: The Linux kernel
# URL:         https://www.kernel.org/
# Maintainer:  protonesso, nagakamira at gmail dot com

name=linux
version=4.17.8
release=3
source=(https://cdn.kernel.org/pub/linux/kernel/v4.x/$name-$version.tar.xz)
BOOTSTRAP=yes

build() {
	yconfig() {
		while [ $# -ne 0 ]; do
			sed -i "s/.*CONFIG_$1\ .*/CONFIG_$1=y/" .config
			grep ^"CONFIG_$1=y" .config || echo "CONFIG_$1=y" >> .config
			shift 1
		done
	}

	cd $name-$version
	unset LDFLAGS
	make mrproper

	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE defconfig

	case $BARCH in
		x86_64)
			yconfig 64BIT UNWINDER_FRAME_POINTER PCI BLK_DEV_SD ATA ATA_SFF ATA_BMDMA ATA_PIIX \
				E1000 SERIAL_8250 SERIAL_8250_CONSOLE=y CONFIG_RTC_CLASS \
				IA32_EMULATION EFI EFI_STUB EFI_MIXED EFI_VARS FB_EFI EFI_RUNTIME_MAP EFIVAR_FS CRYPTO_AES_X86_64 KVM_INTEL KVM_AMD
			;;
		armv7h)
			yconfig MMU ARCH_MULTI_V7 ARCH_VIRT SOC_DRA7XX=y ARCH_OMAP2PLUS_TYPICAL ARCH_ALPINE ARM_THUMB \
				CONFIG_VDSO CPU_IDLE ARM_CPUIDLE KERNEL_MODE_NEON SERIAL_AMBA_PL011 SERIAL_AMBA_PL011_CONSOLE \
				RTC_CLASS RTC_HCTOSYS RTC_DRV_PL031 NET_CORE VIRTIO_MENU VIRTIO_NET PCI PCI_HOST_GENERIC \
				VIRTIO_BLK VIRTIO_PCI VIRTIO_MMIO ATA ATA_SFF ATA_BMDMA ATA_PIIX PATA_PLATFORM \
				PATA_OF_PLATFORM ATA_GENERIC EFI EFI_STUB EFI_MIXED EFI_VARS FB_EFI EFI_RUNTIME_MAP EFIVAR_FS
			;;
		armv6h)
			yconfig CPU_V6 MMU ARM_THUMB AEABI VFP ARCH_VERSATILE ARCH_VERSATILE_PB PCI_LEGACY SERIAL_NONSTANDARD \
				SERIAL_AMBA_PL011 SERIAL_AMBA_PL011_CONSOLE RTC_DRV_PL031 SCSI_SYM53C8XX_2 SCSI_SYM53C8XX_DMA_ADDRESSING_MODE SCSI_SYM53C8XX_MMIO
			;;
		aarch64)
			yconfig EFI EFI_STUB EFI_MIXED EFI_VARS FB_EFI EFI_RUNTIME_MAP EFIVAR_FS
			;;
		mipsel)
			yconfig MIPS_MALTA CPU_MIPS32_R2 SERIAL_8250 SERIAL_8250_CONSOLE PCI BLK_DEV_SD ATA ATA_SFF ATA_BMDMA ATA_PIIX POWER_RESET POWER_RESET_SYSCON CPU_LITTLE_ENDIAN
			;;
		mips)
			yconfig MIPS_MALTA CPU_MIPS32_R2 SERIAL_8250 SERIAL_8250_CONSOLE PCI BLK_DEV_SD ATA ATA_SFF ATA_BMDMA ATA_PIIX POWER_RESET POWER_RESET_SYSCON
			sed -i -e 's:CONFIG_CPU_LITTLE_ENDIAN:CONFIG_CPU_BIG_ENDIAN:' .config
			;;
		ppc64le)
			yconfig PPC64 POWER8_CPU PPC_PSERIES CPU_LITTLE_ENDIAN PPC_OF_BOOT_TRAMPOLINE BLK_DEV_SD SCSI_LOWLEVEL SCSI_IBMVSCSI ATA IBMVETH HVC_CONSOLE \
				PPC_TRANSACTIONAL_MEM PPC_DISABLE_WERROR SECTION_MISMATCH_WARN_ONLY
			;;
	esac

	yconfig CC_OPTIMIZE_FOR_SIZE MODULES EARLY_PRINTK BINFMT_ELF BINFMT_SCRIPT NO_HZ HIGH_RES_TIMERS BLK_DEV BLK_DEV_INITRD \
		BLK_DEV_LOOP EXT2_FS EXT3_FS EXT4_FS EXT4_FS_SECURITY EXT4_FS_POSIX_ACL EXT4_ENCRYPTION \
		VFAT_FS MSDOS_FS FUSE_FS JFS_FS REISERFS_FS XFS_FS BTRFS_FS BTRFS_FS_POSIX_ACL \
		REISERFS_FS_XATTR FAT_DEFAULT_UTF8 MISC_FILESYSTEMS \
		SQUASHFS SQUASHFS_XATTR SQUASHFS_ZLIB=y DEVTMPFS DEVTMPFS_MOUNT \
		TMPFS TMPFS_POSIX_ACL NET PACKET UNIX INET IPV6 NETDEVICES BRIDGE NETFILTER TUN \
		WIRELESS CFG80211 CFG80211_WEXT MAC80211 WLAN ETHERNET \
		PPP PPP_ASYNC PPP_SYNC_TTY HID HID_GENERIC HID_WACOM \
		USB USB_HID USB_SUPPORT USB_XHCI_HCD USB_EHCI_HCD USB_OHCI_HCD USB_PRINTER \
		PARTITION_ADVANCED EFI_PARTITION \
		SOUND SND AUTOFS4_FS NETWORK_FILESYSTEMS NFS_FS NFSD NFSD_V4 CIFS \
		BT BT_RFCOMM BT_RFCOMM_TTY BT_BNEP BT_BNEP_MC_FILTER BT_BNEP_PROTO_FILTER BT_HIDP RFKILL \
		CRYPTO CRYPTO_XTS CRYPTO_SHA256 CRYPTO_AES CRYPTO_USER_API_HASH CRYPTO_USER_API_SKCIPHER CRYPTO_TWOFISH \
		MEDIA_CAMERA_SUPPORT MEDIA_USB_SUPPORT \
		MD MD_AUTODETECT MD_LINEAR MD_RAID0 MD_RAID1 MD_RAID10 MD_RAID456 \
		BLK_DEV_DM DM_CRYPT DM_SNAPSHOT DM_THIN_PROVISIONING DM_MIRROR \
		PARPORT PARPORT_PC PRINTER INPUT INPUT_EVDEV INPUT_MISC INPUT_UINPUT \
		I2C_CHARDEV HWMON MAGIC_SYSRQ SUSPEND HIBERNATION VIRTUALIZATION KVM \
		DNOTIFY DRM FB_VESA NAMESPACES UTS_NS IPC_NS USER_NS \
		PID_NS NET_NS DEVPTS_MULTIPLE_INSTANCES CGROUPS \
		CGROUP_DEVICE CPUSETS CGROUP_FREEZER CGROUP_SCHED BLK_CGROUP= CFQ_GROUP_IOSCHED \
		CGROUP_MEM_RES_CTLR CGROUP_MEM_RES_CTLR_SWAP CGROUP_CPUACCT VETH MACVLAN VLAN_8021Q \
		VIRTIO VIRTIO_PCI VIRTIO_NET VIRTIO_BLK VIRTIO_MMIO VIRTIO_BALLOON \
		MEMCG KEYS BRIDGE_NETFILTER NF_NAT_IPV4  IP_NF_FILTER \
		NETFILTER_XT_MATCH_CONNTRACK NETFILTER_XT_MATCH_IPVS IP_NF_NAT NF_NAT NF_NAT_NEEDED \
		IP_NF_NAT NF_NAT NF_NAT_NEEDED POSIX_MQUEUE SECCOMP CGROUP_PIDS \
		MEMCG_SWAP MEMCG_SWAP_ENABLED BLK_DEV_THROTTLING IOSCHED_CFQ CGROUP_PERF CGROUP_HUGETLB \
		NET_CLS_CGROUP CFS_BANDWIDTH FAIR_GROUP_SCHED RT_GROUP_SCHED \
		IP_VS IP_VS_PROTO_TCP IP_VS_PROTO_UDP IP_VS_NFCT IP_VS_RR \
		CRYPTO_AEAD CRYPTO_GCM CRYPTO_SEQIV CRYPTO_GHASH XFRM_ALGO XFRM_USER \
		RESOURCE_COUNTERS NETPRIO_CGROUP CGROUP_NET_PRIO MEMCG_KMEM DEVPTS_MULTIPLE_INSTANCES \
		NETLINK_DIAG PACKET_DIAG INET_UDP_DIAG \
		INET_TCP_DIAG UNIX_DIAG CHECKPOINT_RESTORE SECURITY_APPARMOR AUDIT \
		SECURITY KALLSYMS SECURITY_PATH SECURITY_NETWORK SECURITYFS SECURITY_NETWORK \
		SECURITY_PATH SECURITY_TOMOYO INPUT_TOUCHSCREEN TOUCHSCREEN_PROPERTIES FRAMEBUFFER_CONSOLE

	case $BARCH in
		mipsel)
			sed -i -e 's:CONFIG_CPU_BIG_ENDIAN:CONFIG_CPU_LITTLE_ENDIAN:' .config
			;;
		mips)
			sed -i -e 's:CONFIG_CPU_LITTLE_ENDIAN:CONFIG_CPU_BIG_ENDIAN:' .config
			;;
	esac

	# Video drivers
	yconfig DRM_RADEON DRM_AMDGPU DRM_AMDGPU_SI DRM_AMDGPU_CIK \
		DRM_NOUVEAU DRM_NOUVEAU_BACKLIGHT DRM_VMWGFX DRM_VMWGFX_FBCON \
		DRM_I915 DRM_I915_ALPHA_SUPPORT DRM_I915_CAPTURE_ERROR DRM_I915_COMPRESS_ERROR DRM_I915_USERPTR DRM_I915_GVT DRM_I915_GVT_KVMGT \
		VIRTIO_GPU DRM_QLX DRM_GMA500 DRM_GMA600 DRM_GMA3600 DRM_CIRRUS_QEMU

	# Network drivers
	yconfig NET_VENDOR_3COM NET_VENDOR_ADAPTEC NET_VENDOR_AGERE NET_VENDOR_ALACRITECH NET_VENDOR_ALTEON NET_VENDOR_AMAZON NET_VENDOR_AMD \
		NET_VENDOR_AQUANTIA NET_VENDOR_ARC NET_VENDOR_ATHEROS NET_VENDOR_AURORA NET_VENDOR_BROADCOM _NET_VENDOR_BROCADE NET_VENDOR_CAVIUM \
		NET_VENDOR_CHELSIO NET_VENDOR_CISCO NET_VENDOR_CORTINA NET_VENDOR_DEC NET_VENDOR_DLINK NET_VENDOR_EMULEX NET_VENDOR_EZCHIP NET_VENDOR_EXAR \
		NET_VENDOR_FUJITSU NET_VENDOR_HP NET_VENDOR_HUAWEI NET_VENDOR_INTEL NET_VENDOR_I825XX NET_VENDOR_MARVELL NET_VENDOR_MELLANOX NET_VENDOR_MICREL \
		NET_VENDOR_MICROCHIP NET_VENDOR_MYRI NET_VENDOR_NATSEMI NET_VENDOR_NETRONOME NET_VENDOR_NI NET_VENDOR_8390 NET_VENDOR_NVIDIA NET_VENDOR_OKI \
		NET_VENDOR_QLOGIC NET_VENDOR_QUALCOMM NET_VENDOR_REALTEK NET_VENDOR_RENESAS NET_VENDOR_RDC NET_VENDOR_ROCKER NET_VENDOR_SAMSUNG NET_VENDOR_SEEQ \
		NET_VENDOR_SILAN NET_VENDOR_SIS NET_VENDOR_SOLARFLARE NET_VENDOR_SMSC NET_VENDOR_SOCIONEXT NET_VENDOR_STMICRO VENDOR_SUN NET_VENDOR_TEHUTI \
		NET_VENDOR_TI NET_VENDOR_VIA NET_VENDOR_WIZNET NET_VENDOR_XIRCOM NET_VENDOR_SYNOPSYS NET_VENDOR_IBM

	# Wireless drivers
	yconfig WLAN_VENDOR_ADMTEK WLAN_VENDOR_ATH WLAN_VENDOR_ATMEL WLAN_VENDOR_BROADCOM WLAN_VENDOR_CISCO WLAN_VENDOR_INTEL WLAN_VENDOR_INTERSIL \
		WLAN_VENDOR_MARVELL WLAN_VENDOR_MEDIATEK WLAN_VENDOR_RALINK WLAN_VENDOR_REALTEK WLAN_VENDOR_RSI WLAN_VENDOR_ST WLAN_VENDOR_TI WLAN_VENDOR_ZYDAS WLAN_VENDOR_QUANTENNA

	# Misc
	yconfig ATM_DRIVERS USB_NET_DRIVERS IEEE802154_DRIVERS V4L_PLATFORM_DRIVERS V4L_MEM2MEM_DRIVERS V4L_TEST_DRIVERS DVB_PLATFORM_DRIVERS \
		CEC_PLATFORM_DRIVERS SDR_PLATFORM_DRIVERS SND_DRIVERS VIRT_DRIVERS COMEDI_MISC_DRIVERS COMEDI_PCI_DRIVERS COMEDI_PCMCIA_DRIVERS COMEDI_USB_DRIVERS

	yes '' | make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE silentoldconfig

	sed -i "s/.*CONFIG_DEFAULT_HOSTNAME.*/CONFIG_DEFAULT_HOSTNAME=\"janus\"/" .config
	sed -i "s/.*\\(CONFIG_KERNEL_.*\\)=y/\\#\\ \\1 is not set/" .config
	sed -i "s/.*CONFIG_KERNEL_XZ.*/CONFIG_KERNEL_XZ=y/" .config
	sed -i "s/^CONFIG_DEBUG_KERNEL.*/\\# CONFIG_DEBUG_KERNEL is not set/" .config

	yes '' | make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE silentoldconfig

	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE

	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE INSTALL_MOD_PATH=$PKG/usr modules_install

	mkdir -p $PKG/boot
	case $BARCH in
		x86_64)
			cp arch/x86/boot/bzImage $PKG/boot/vmlinuz
			;;
		aarch64)
			make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE INSTALL_DTBS_PATH=$PKG/boot/dtbs dtbs_install
			cp arch/arm64/boot/Image $PKG/boot/vmlinuz
			;;
		armv7h|armv6h)
			make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE INSTALL_DTBS_PATH=$PKG/boot/dtbs dtbs_install
			cp arch/arm/boot/zImage $PKG/boot/vmlinuz
			;;
		mips|mipsel)
			cp vmlinux $PKG/boot/vmlinuz
			;;
		ppc64le)
			cp vmlinux $PKG/boot/vmlinuz
			;;
	esac
}
