# Maintainer: protonesso <nagakamira@gmail.com>

pkgname=linux
pkgver=4.17
pkgrel=3
arch=('x86_64')
url="https://www.kernel.org/"
license=('GPL')
groups=('base')
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/linux-$pkgver.tar.xz")

yconfig() {
	while [ $# -ne 0 ]; do
		sed -i "s/.*CONFIG_$1\ .*/CONFIG_$1=y/" .config
		grep ^"CONFIG_$1=y" .config || echo "CONFIG_$1=y" >> .config
		shift 1
	done
}

build() {
	cd "$srcdir/$pkgname-$pkgver"
	unset LDFLAGS
	make mrproper

	msg "Generating Linux kernel config"
	make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- defconfig

	yconfig UNWINDER_FRAME_POINTER BLK_DEV_SD ATA ATA_SFF ATA_BMDMA \
		ATA_PIIX E1000 SERIAL_8250 SERIAL_8250_CONSOLE RTC_CLASS KERNEL_XZ MULTIUSER BLOCK NO_HZ SWAP SYSVIPC \
		IKCONFIG IKCONFIG_PROC CC_OPTIMIZE_FOR_SIZE PCI BINFMT_ELF BINFMT_SCRIPT MAGIC_SYSRQ SMP \
		HIGH_RES_TIMERS BLK_DEV BLK_DEV_INITRD RD_GZIP BLK_DEV_LOOP SATA_AHCI \
		EXT2_FS EXT3_FS EXT4_FS BTRFS_FS JFS_FS \
		REISERFS_FS XFS_FS MSDOS_FS VFAT_FS FUSE_FS PROC_FS SYSFS FAT_DEFAULT_UTF8 \
		MISC_FILESYSTEMS SQUASHFS SQUASHFS_XATTR SQUASHFS_ZLIB DEVTMPFS DEVTMPFS_MOUNT \
		TMPFS TMPFS_POSIX_ACL SHMEM AUTOFS4_FS NETWORK_FILESYSTEMS NFS_FS NFSD CIFS \
		NET PACKET UNIX INET IPV6 _NETDEVICES ETHERNET BRIDGE NETFILTER IDE IDE_GD IDE_GD_ATA \
		BLK_DEV_IDECD SCSI BLK_DEV_SR SCSI_LOWLEVEL 8139CP HW_RANDOM \
		RTC_CLASS RTC_HCTOSYS RTC_INTF_SYSFS RTC_INTF_DEV INITRAMFS_COMPRESSION_GZIP=y \
		VIRTUALIZATION VIRTIO VIRTIO_PCI VIRTIO_NET VIRTIO_BLK VIRTIO_MMIO \
		VIRTIO_CONSOLE NET_9P NET_9P_VIRTIO 9P_FS 9P_FS_POSIX_ACL \
		PPP PPP_ASYNC PPP_SYNC_TTY HID HID_GENERIC HID_WACOM USB USB_HID USB_SUPPORT \
		USB_XHCI_HCD USB_EHCI_HCD USB_OHCI_HCD USB_STORAGE USB_PRINTER PARTITION_ADVANCED \
		EFI_PARTITION _EFI EFI_STUB EFI_MIXED EFI_VARS SOUND SND RFKILL \
		BT BT_RFCOMM BT_BNEP BT_BNEP_MC_FILTER BT_BNEP_PROTO_FILTER BT_HIDP \
		CRYPTO CRYPTO_USER_API_HASH CRYPTO_USER_API_SKCIPHER MEDIA_CAMERA_SUPPORT MEDIA_USB_SUPPORT MD \
		MD_AUTODETECT MD_LINEAR MD_RAID0 MD_RAID1 MD_RAID10 MD_RAID456 BLK_DEV_DM DM_CRYPT \
		DM_SNAPSHOT DM_THIN_PROVISIONING DM_MIRROR MAGIC_SYSRQ CRYPTO_XTS CRYPTO_SHA256 CRYPTO_AES \
		CRYPTO_AES_X86_64 CRYPTO_USER_API_SKCIPHER CRYPTO_TWOFISH PRINTER PARPORT PARPORT_PC=y \
		INPUT INPUT_EVDEV INPUT_MISC INPUT_UINPUT MODULES I2C_CHARDEV HWMON \
		SUSPEND HIBERNATION KVM KVM_INTEL KVM_AMD TUN WIRELESS CFG80211 CFG80211_WEXT MAC80211 WLAN \
		DRM DRM_AMDGPU DRM_AMDGPU_SI DRM_AMDGPU_CIK DRM_RADEON DRM_I915 \
		DRM_NOUVEAU DRM_NOUVEAU_BACKLIGHT DRM_VMWGFX DRM_VMWGFX_FBCON \
		X86_EXTENDED_PLATFORM X86_VSMP INPUT_MOUSE MOUSE_PS2 MOUSE_PS2_VMMOUSE NAMESPACES UTS_NS \
		IPC_NS USER_NS PID_NS NET_NS DEVPTS_MULTIPLE_INSTANCES CGROUPS CGROUP_DEVICE CPUSETS \
		CGROUP_FREEZER CGROUP_SCHE BLK_CGROUP CFQ_GROUP_IOSCHED CGROUP_MEM_RES_CTLR \
		CGROUP_MEM_RES_CTLR_SWAP CGROUP_CPUACCT VETH MACVLAN VLAN_8021Q FB_VESA OVERLAY_FS \
		SECURITY KALLSYMS SECURITY_PATH SECURITY_NETWORK SECURITYFS SECURITY_TOMOYO \
		SECURITY_APPARMOR AUDIT

	sed -i "s/^CONFIG_NET_CORE.*/\\# CONFIG_NET_CORE is not set/" .config
	sed -i "s/^CONFIG_NETCONSOLE.*/\\# CONFIG_NETCONSOLE is not set/" .config
	sed -i "s/^CONFIG_DEBUG_KERNEL.*/\\# CONFIG_DEBUG_KERNEL is not set/" .config
	sed -i "s/^CONFIG_EMBEDDED.*/\\# CONFIG_EMBEDDED is not set/" .config
	sed -i "s/.*CONFIG_DEFAULT_HOSTNAME.*/CONFIG_DEFAULT_HOSTNAME=\"janus\"/" .config

	yes '' | make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- silentoldconfig
	make ARCH=$XKARCH CROSS_COMPILE=$XTARGET-
}

package() {
	cd "$srcdir/$pkgname-$pkgver"
	make ARCH=$XKARCH CROSS_COMPILE=$XTARGET- INSTALL_MOD_PATH=$pkgdir/usr modules_install

	mkdir -p $pkgdir/boot
	cp arch/x86/boot/bzImage $pkgdir/boot/vmlinuz
}
