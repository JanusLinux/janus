# Description: Size optimized toolbox of many common UNIX utilities
# URL:         https://www.busybox.net/
# Maintainer:  protonesso, nagakamira at gmail dot com

name=busybox
version=1.30.1
release=1
source=("http://busybox.net/downloads/$name-$version.tar.bz2")
BOOTSTRAP=yes

build() {
	cd "$SRC"/$name-$version
	make mrproper
	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE defconfig
	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE EXTRA_CFLAGS="$CFLAGS" CONFIG_STATIC=y
	make ARCH=$XKARCH CROSS_COMPILE=$CROSS_COMPILE EXTRA_CFLAGS="$CFLAGS" busybox.links


	install -D busybox "$PKG"/usr/bin/busybox

	for applet in `cat busybox.links|sed 's|^.*/||'`; do ln -s busybox "$PKG"/usr/bin/$applet || true; done

	mkdir -p "$PKG"/usr/share/udhcpc
	install -Dm0755 "$SRC"/$name-$version/examples/udhcp/simple.script "$PKG"/usr/share/udhcpc/default.script

	cd "$PKG"

	mkdir -p etc/init.d

	echo '#!/usr/bin/busybox hush' > etc/init.d/rcS
	echo 'export PATH=/usr/bin' >> etc/init.d/rcS
	echo 'dmesg -n 1' >> etc/init.d/rcS
	echo 'mount -t devtmpfs none /dev' >> etc/init.d/rcS
	echo 'mount -t proc none /proc' >> etc/init.d/rcS
	echo 'mount -t sysfs none /sys' >> etc/init.d/rcS
	echo 'setsid cttyhack /usr/bin/hush' >> etc/init.d/rcS
	echo 'echo Welcome to Ataraxia Linux Embedded Edition!' >> etc/init.d/rcS
	chmod +x etc/init.d/rcS
}
