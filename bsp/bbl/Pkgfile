# Description: RISC-V Proxy Kernel
# URL:         https://github.com/riscv/riscv-pk
# Maintainer:  nee-san, nagakamira at gmail dot com

name=bbl
version=a1c125dde740f5acd1e20a341cf3426ea44af292
release=1
source=("https://github.com/riscv/riscv-pk/archive/$version.tar.gz")
BOOTSTRAP=yes

build() {
	unset CXXFLAGS LDFLAGS

	export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/}"
	export CFLAGS="${CFLAGS/ -fstack-protector-strong/}"
	export CFLAGS="${CFLAGS/ -Wl,-z,relro,-z,now/}"
	export CFLAGS="-fno-PIE -fno-stack-protector -Wl,-z,norelro,-z,nonow -fPIC $CFLAGS"
	export CXXFLAGS="$CFLAGS"

	case $BARCH in
		riscv64|riscv32)
			true
			;;
		*)
			echo "RISC V supported only"
			exit 1
	esac

	if [[ ! -f "$ROOTFS"/boot/vmlinuz-linux ]]; then
		echo "Compile kernel first!"
		exit 1
	fi

	cd "$SRC"/riscv-pk-$version

	mkdir build
	cd build

	../configure $BUILDFLAGS \
		--prefix= \
		--with-payload="$ROOTFS/boot/vmlinuz-linux" \
		--enable-logo \
		--with-logo="$KEEP/bbl/logo.txt"
	make

	mkdir -p "$PKG"/boot
	cp bbl "$PKG"/boot/bbl-linux
}
