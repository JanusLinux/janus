# Description: The Linux kernel
# URL:         https://www.kernel.org/
# Maintainer:  protonesso, nagakamira at gmail dot com
# Depends on:  kmod bc libelf xz openssl

name=linux
version=4.19.34
release=1
source=("https://cdn.kernel.org/pub/linux/kernel/v4.x/$name-$version.tar.xz")
BOOTSTRAP=yes
NO_RUN_STRIP=1

build() {
	case $BARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		i486)
			export XKARCH="i386"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		ppc64le|ppc64|ppc)
			export XKARCH="powerpc"
			export IMAGELOC="vmlinux"
			;;
		*)
			echo "Architecture is not set or is not supported by Ataraxia Linux"
			exit 1
	esac

	cd "$SRC"/$name-$version
	patch -Np1 -i "$STUFF"/linux/wireguard.patch

	unset LDFLAGS
	make mrproper

	if [ -f /boot/config-linux ]; then
			cp /boot/config-linux .config
	else
			cp "$STUFF"/linux/$BARCH.config .config
	fi

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE}
	else
		make ARCH=$XKARCH
	fi

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} INSTALL_MOD_PATH="$PKG"/usr modules_install
	else
		make ARCH=$XKARCH INSTALL_MOD_PATH="$PKG"/usr modules_install
	fi

	mkdir -p "$PKG"/boot
	cp "$IMAGELOC" "$PKG"/boot/vmlinuz-linux
	cp .config "$PKG"/boot/config-linux
}
