# Description: The Linux kernel
# URL:         https://www.kernel.org/
# Maintainer:  nee-san, nagakamira at gmail dot com
# Depends on:  kmod bc libelf xz libressl coreutils

name=linux
version=5.0
release=1
source=("https://cdn.kernel.org/pub/linux/kernel/v5.x/$name-$version.tar.xz")
BOOTSTRAP=yes
NO_RUN_STRIP=1

yconfig() {
	while [ $# -ne 0 ]; do
		sed -i "s/.*CONFIG_$1\ .*/CONFIG_$1=y/" .config
		grep ^"CONFIG_$1=y" .config || echo "CONFIG_$1=y" >> .config
		shift 1
	done
}

mconfig() {
	while [ $# -ne 0 ]; do
		sed -i "s/.*CONFIG_$1\ .*/CONFIG_$1=,/" .config
		grep ^"CONFIG_$1=," .config || echo "CONFIG_$1=," >> .config
		shift 1
	done
}

nconfig() {
	while [ $# -ne 0 ]; do
		sed -i "s/.*CONFIG_$1\ .*/CONFIG_$1/" .config
		grep ^"# CONFIG_$1 is not set" .config || echo "# CONFIG_$1 is not set" >> .config
		shift 1
	done
}

generate_config() {
	case $BARCH in
		x86_64|i586)
			SUBKARCH="x86"
			;;
		*)
			SUBKARCH="$XKARCH"
			;;
	esac

	case $BARCH in
		x86_64)
			export DEFCONFIG="x86_64_defconfig"
			;;
		i586)
			export DEFCONFIG="i386_defconfig"
			;;
		aarch64)
			export DEFCONFIG="defconfig"
			;;
		armv7l)
			export DEFCONFIG="multi_v7_defconfig"
			;;
		armv5tel)
			export DEFCONFIG="multi_v5_defconfig"
			;;
		mips64|mips64el|mips|mipsel)
			export DEFCONFIG="malta_defconfig"
			;;
		ppc64le)
			export DEFCONFIG="powernv_defconfig"
			;;
		ppc64)
			export DEFCONFIG="g5_defconfig"
			;;
		ppc)
			export DEFCONFIG="pmac32_defconfig"
			;;
		riscv64|riscv32)
			export DEFCONFIG="defconfig"
			;;
		*)
			echo "Architecture is not set or is not supported by januslinux"
			exit 1
	esac

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} $DEFCONFIG
	else
		make ARCH=$XKARCH $DEFCONFIG
	fi

	case $BARCH in
		x86_64|i586)
			for archconf in PCI BLK_DEV_SD ATA ATA_SFF ATA_BMDMA ATA_PIIX NET_VENDOR_INTEL E1000 SERIAL_8250 SERIAL_8250_CONSOLE RTC_CLASS; do
				yconfig $archconf
			done
			;;
		mips64|mips64el|mips|mipsel)
			for archconf in SERIAL_8250 SERIAL_8250_CONSOLE PCI BLK_DEV_SD ATA ATA_SFF ATA_BMDMA ATA_PIIX NET_VENDOR_AMD PCNET32 POWER_RESET POWER_RESET_SYSCON; do
				yconfig $archconf
			done
			;;
		riscv64|riscv32)
			for archconf in RISCV_ISA_C RISCV_ISA_A FPU SIFIVE_PLIC; do
				yconfig $archconf
			done
			;;
	esac

	case $BARCH in
		x86_64)
			for archconf in 64BIT IA32_EMULATION; do
				yconfig $archconf
			done
			;;
		i586)
			yconfig M586
			;;
		ppc64le)
			yconfig POWER8_CPU
			yconfig TARGET_CPU_BOOL
			sed -i "s/.*CONFIG_TARGET_CPU.*/CONFIG_TARGET_CPU=\"power8\"/" .config
			;;
	esac

	case $BARCH in
		mips64|mips64el)
			nconfig CPU_MIPS32_R2
			nconfig 32BIT
			for archconf in CPU_MIPS64_R2 MIPS_O32_FP64_SUPPORT 64BIT MIPS32_O32 MIPS32_N32; do
				yconfig $archconf
			done
			;;
	esac

	case $BARCH in
		riscv64|riscv32)
			for archconf in ARCH_RV32I ARCH_RV64I 64BIT; do
				nconfig $archconf
			done
			;;
	esac

	case $BARCH in
		riscv64)
			for archconf in AARCH_RV64I 64BIT; do
				yconfig $archconf
			done
			;;
		riscv32)
			yconfig ARCH_RV32I
			;;
	esac

	case $BARCH in
		mips64|mips64el)
			nconfig CPU_MIPS32_R2
			nconfig 32BIT
			for archconf in CPU_MIPS64_R2 MIPS_O32_FP64_SUPPORT 64BIT MIPS32_O32 MIPS32_N32; do
				yconfig $archconf
			done
			;;
	esac

	# temp
	for kernelconf in EARLY_PRINTK BINFMT_ELF BINFMT_SCRIPT NO_HZ HIGH_RES_TIMERS BLK_DEV BLK_DEV_INITRD RD_GZIP \
					BLK_DEV_LOOP EXT4_FS_POSIX_ACL EXT4_FS_SECURITY EXT4_FS EXT4_USE_FOR_EXT2 VFAT_FS FAT_DEFAULT_UTF8 MISC_FILESYSTEMS \
					SQUASHFS SQUASHFS_XATTR SQUASHFS_ZLIB DEVTMPFS DEVTMPFS_MOUNT TMPFS TMPFS_POSIX_ACL \
					NET PACKET UNIX INET IPV6 NETDEVICES NET_CORE NETCONSOLE ETHERNET UNIX ONFIG_DRM RPMSG VSOCKETS NET_9P \
					MODULES MODULE_UNLOAD MODVERSIONS MODULE_SRCVERSION_ALL \
					ETLINK_DIAG NETWORK_FILESYSTEMS DRM_VIRTIO_GPU NET_9P_VIRTIO RPMSG_VIRTIO VIRTIO_BALLOON \
					VIRTIO_BLK VIRTIO_CONSOLE VIRTIO_INPUT VIRTIO_MENU VIRTIO_MMIO VIRTIO_MMIO_CMDLINE_DEVICES \
					VIRTIO_NET VIRTIO_PCI VIRTIO_PCI_LEGACY VIRTIO_VSOCKETS \
					9P_FS_POSIX_ACL 9P_FS_SECURITY 9P_FS 9P_FSCACHE; do
		yconfig $kernelconf
	done

	nconfig EMBEDDED

	sed -i "s/.*CONFIG_DEFAULT_HOSTNAME.*/CONFIG_DEFAULT_HOSTNAME=\"mai\"/" .config

	if [ "$CROSS" = "yes" ]; then
		yes '' | make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} oldconfig
	else
		yes '' | make ARCH=$XKARCH oldconfig
	fi
}

build() {
	case $BARCH in
		x86_64)
			export XKARCH="x86_64"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		i586)
			export XKARCH="i386"
			export IMAGELOC="arch/x86/boot/bzImage"
			;;
		aarch64)
			export XKARCH="arm64"
			export IMAGELOC="arch/arm64/boot/Image"
			;;
		armv7l|armv5tel)
			export XKARCH="arm"
			export IMAGELOC="arch/arm/boot/zImage"
			;;
		mips64|mips64el|mips|mipsel)
			export XKARCH="mips"
			export IMAGELOC="vmlinux"
			;;
		ppc64le|ppc64|ppc)
			export XKARCH="powerpc"
			export IMAGELOC="vmlinux"
			;;
		riscv64|riscv32)
			export XKARCH="riscv"
			export IMAGELOC="vmlinux"
			;;
		*)
			echo "Architecture is not set or is not supported by januslinux"
			exit 1
	esac

	cd "$SRC"/$name-$version
	unset LDFLAGS
	make mrproper

	if [ "$CROSS" != "yes" ]; then
		if [ -f /boot/config-linux ]; then
			cp /boot/config-linux .config
		else
			generate_config
		fi
	else
		generate_config
	fi

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE}
	else
		make ARCH=$XKARCH
	fi

	if [ "$CROSS" = "yes" ]; then
		make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} INSTALL_MOD_PATH="$PKG"/usr modules_install
	else
		make ARCH=$XKARCH INSTALL_MOD_PATH="$PKG"/usr modules_install
	fi

	mkdir -p "$PKG"/boot
	cp "$IMAGELOC" "$PKG"/boot/vmlinuz-linux
	cp .config "$PKG"/boot/config-linux

	case $BARCH in
		aarch64|armv7l|armv5tel)
			if [ "$CROSS" = "yes" ]; then
				make ARCH=$XKARCH CROSS_COMPILE=${CROSS_COMPILE} INSTALL_DTBS_PATH="$PKG"/boot/dtbs dtbs_install
			else
				make ARCH=$XKARCH INSTALL_DTBS_PATH="$PKG"/boot/dtbs dtbs_install
			fi
			;;
		riscv64|riscv32)
			${CROSS_COMPILE}objcopy -O binary "$PKG"/boot/vmlinuz-linux "$PKG"/boot/vmlinuz-linux.bin
			;;
	esac
}

