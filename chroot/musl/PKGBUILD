pkgname=chroot-musl
pkgver=1.1.21
pkgrel=1
arch=('x86_64' 'x86' 'arm64' 'armv7l' 'armv5tel' 'ppc64le' 'ppc64' 'ppc')
source=("https://www.musl-libc.org/releases/musl-$pkgver.tar.gz"
	'__stack_chk_fail_local.c')

build() {
	cd "$srcdir"/musl-$pkgver
	$XTARGET-gcc $CFLAGS -c "$srcdir"/__stack_chk_fail_local.c -o __stack_chk_fail_local.o
	$XTARGET-ar r libssp_nonshared.a __stack_chk_fail_local.o

	CROSS_COMPILE=$XTARGET- \
	./configure \
		--prefix=/tools \
		--libdir=/tools/lib \
		--syslibdir=/tools/lib \
		--build=$XHOST \
		--host=$XTARGET \
		--target=$XTARGET \
		--enable-optimize=size
	make
}

package() {
	cd "$srcdir"/musl-$pkgver
	make DESTDIR="$pkgdir" install

	cp libssp_nonshared.a "$pkgdir"/tools/lib

	mkdir -p "$pkgdir"/tools/bin
	ln -sf ../lib/libc.so "$pkgdir"/tools/bin/ldd
}
