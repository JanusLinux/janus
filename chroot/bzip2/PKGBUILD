pkgname=chroot-bzip2
pkgver=1.0.6
pkgrel=1
arch=('x86_64' 'x86' 'arm64' 'armv7l' 'armv5tel' 'mips64' 'mips' 'ppc64le' 'ppc64' 'ppc')
source=("https://sources.archlinux.org/other/packages/bzip2/bzip2-$pkgver.tar.gz")

prepare() {
	cd "$srcdir"/bzip2-$pkgver
	cp Makefile{,.orig}
	sed -e '/^all/s/ test$//' Makefile.orig > Makefile
	sed -e 's/^CFLAGS=\(.*\)$/CFLAGS=\1 \$(BIGFILES)/' -i ./Makefile-libbz2_so
	sed -i "s|-O2|${CFLAGS} -fPIC|g" Makefile
	sed -i "s|-O2|${CFLAGS} -fPIC|g" Makefile-libbz2_so
}

build() {
	cd "$srcdir"/bzip2-$pkgver
	make CC="$CC" AR="$AR" RANLIB="$RANLIB"
	make CC="$CC" AR="$AR" RANLIB="$RANLIB" -f Makefile-libbz2_so
}

package() {
	cd "$srcdir"/bzip2-$pkgver
	make PREFIX="$pkgdir"/tools install

	install -m755 libbz2.so.1.0.6 "$pkgdir"/tools/lib
	ln -sf libbz2.so.1.0.6 "$pkgdir"/tools/lib/libbz2.so
	ln -sf libbz2.so.1.0.6 "$pkgdir"/tools/lib/libbz2.so.1
	ln -sf libbz2.so.1.0.6 "$pkgdir"/tools/lib/libbz2.so.1.0
}
