# Maintainer: protonesso <nagakamira@gmail.com>

pkgname=ca-certificates
pkgver=20180409
pkgrel=1
pkgdesc="Common CA certificates (default providers)"
arch=('x86_64' 'aarch64' 'armhf' 's390x')
url="https://januslinux.github.io/"
license=('custom')
groups=('base')
depends=('musl' 'libressl')
source=("https://github.com/protonesso/yoctus-baselayout/raw/master/ca-certificates_20180409.tar.xz"
	'certdata2pem.c'
	'c_rehash.c'
	'update-ca-certificates.hook')

build() {
	cd "$srcdir/$pkgname"
cat > sbin/Makefile << EOF
install:
	install -Dm755 update-ca-certificates \$(DESTDIR)\$(SBINDIR)/update-ca-certificates
EOF

mv $srcdir/certdata2pem.c mozilla/certdata2pem.c

cat > mozilla/Makefile << EOF
all:
	$HOSTCC -Wall certdata2pem.c -o certdata2pem
	./certdata2pem
clean:
	-rm -f *.crt
install:
	for p in *.crt; do \
	    install -Dm0644 \$\$p \$(CERTSDIR)/\$\$p ; \
	done
EOF

	make

	$CC $srcdir/c_rehash.c -o $srcdir/c_rehash -L$ROOTFS/usr/lib -lssl -lcrypto -lz $CFLAGS $LDFLAGS
}

package() {
	unset MAKEFLAGS
	cd "$srcdir/$pkgname"
	make DESTDIR=$pkgdir SBINDIR=/usr/bin install

	mkdir -p $pkgdir/etc
	find $pkgdir/usr/share/${pkgname}/ -name '*.crt' | \
		rev | cut -d/ -f1-2 | rev | sort > $pkgdir/etc/ca-certificates.conf

	install -Dm0755 $srcdir/c_rehash $pkgdir/usr/bin/c_rehash

	install -Dm644 $srcdir/update-ca-certificates.hook $pkgdir/usr/share/libalpm/hooks/update-ca-certificates.hook

	msg "Stripping package $pkgname..."
	find $pkgdir -type f | xargs file 2>/dev/null | grep "LSB executable"       | cut -f 1 -d : | xargs $STRIP --strip-all			2>/dev/null || true
	find $pkgdir -type f | xargs file 2>/dev/null | grep "shared object"        | cut -f 1 -d : | xargs $STRIP --strip-unneeded		2>/dev/null || true
	find $pkgdir -type f | xargs file 2>/dev/null | grep "current ar archive"   | cut -f 1 -d : | xargs $STRIP --strip-debug		2>/dev/null || true
	cd $pkgdir
	rm -rf usr/{,local/}{,share/}{doc,man,info,locale} usr{,/local}{,/share},opt/*}/{man,info} usr/{,local/}{,share/}{doc,gtk-doc} opt/*/{doc,gtk-doc}
	rm -rf $pkgdir/{,usr/}lib/charset.alias
}
md5sums=('8425f4b1219e4e528db2de764e4c6586'
         '1c759bac40fcae93119696ae24144ee2'
         'eba0f9b8d993f21c900a12ca03301344'
         'dff703d85ca3e8adade734e59ca0b41f')
